# 实施计划：企业级 SaaS 升级

## 概述

本实施计划将蓝图AI系统架构梳理工具升级为企业级多租户 SaaS 产品。实施采用 Palantir 本体设计模式，分8个阶段逐步完成。每个阶段都是可独立交付的功能集，确保增量价值和风险控制。

**技术栈**：TypeScript + Node.js + PostgreSQL + Redis

**实施原则**：
1. 从单一决策面开始，而非试图一次性建模整个企业
2. 优先实现核心本体对象和链接类型
3. 所有写操作通过 Actions 执行
4. 使用 DecisionReceipt 记录重要决策
5. 每个阶段结束时进行检查点验证

## 任务列表

### 第一阶段：基础多租户架构和本体层

- [x] 1. 设置项目基础架构
  - 初始化 TypeScript + Node.js 项目
  - 配置 TypeORM/Prisma ORM
  - 设置 PostgreSQL 数据库连接
  - 配置 Redis 缓存
  - 设置环境变量管理
  - _需求：26.1, 26.4_

- [x] 2. 实现核心本体服务
  - [x] 2.1 创建 OntologyService 基础接口
    - 实现对象查询方法（getObject, queryObjects）
    - 实现链接遍历方法（getLinkedObjects, traversePath）
    - 实现批量查询方法
    - _需求：1.1, 2.1_
  
  - [ ]* 2.2 为 OntologyService 编写属性测试
    - **属性 29：依赖图完整性** - 验证链接遍历的完整性
    - **验证需求：13.1, 13.2**
  
  - [x] 2.3 实现 Action 基础框架
    - 创建 Action 基类和接口
    - 实现权限检查机制
    - 实现审计日志记录
    - 实现事务管理
    - _需求：2.7, 10.1_
  
  - [ ]* 2.4 为 Action 框架编写属性测试
    - **属性 7：权限变更被审计** - 验证所有 Action 都记录审计日志
    - **验证需求：2.9**


- [x] 3. 实现组织管理对象类型
  - [x] 3.1 创建 Organization 对象类型和数据库表
    - 定义 Organization 接口和属性
    - 创建 organizations 表和索引
    - 实现 Organization Repository
    - _需求：1.1, 26.4_
  
  - [x] 3.2 实现 CreateOrganizationAction
    - 创建组织
    - 自动将创建者设为管理员
    - 生成 DecisionReceipt
    - _需求：1.2_
  
  - [ ]* 3.3 为组织创建编写属性测试
    - **属性 1：组织创建者自动成为管理员** - 验证创建者角色分配
    - **验证需求：1.2**
  
  - [x] 3.4 创建 Department 对象类型（树形结构）
    - 定义 Department 接口
    - 创建 departments 表（使用 ltree）
    - 实现部门树操作方法
    - _需求：1.3, 1.4_
  
  - [ ]* 3.5 为部门树编写属性测试
    - **属性 2：部门树形结构一致性** - 验证路径和父子关系
    - **验证需求：1.3, 1.4**
  
  - [x] 3.6 创建 Member 对象类型
    - 定义 Member 接口和角色枚举
    - 创建 members 表
    - 实现成员管理方法
    - _需求：1.5, 2.1_
  
  - [x] 3.7 实现成员分配和转移 Actions
    - AssignMemberToDepartmentAction
    - TransferMemberAction
    - _需求：1.5, 1.6_
  
  - [ ]* 3.8 为成员转移编写属性测试
    - **属性 3：成员转移保持唯一性** - 验证成员只属于一个部门
    - **验证需求：1.6**

- [ ] 4. 实现权限管理系统
  - [ ] 4.1 定义权限枚举和角色映射
    - 创建 Permission 枚举
    - 定义 RolePermissions 映射
    - _需求：2.1, 2.2, 2.3, 2.4, 2.5_
  
  - [ ] 4.2 实现 PermissionService
    - hasPermission 方法
    - checkPermission 方法（抛出异常）
    - getUserPermissions 方法
    - _需求：2.6, 2.7_
  
  - [ ]* 4.3 为权限系统编写属性测试
    - **属性 4：角色权限边界** - 验证所有角色的权限正确性
    - **属性 5：项目级权限覆盖** - 验证权限覆盖机制
    - **属性 6：未授权访问被拒绝** - 验证权限检查
    - **验证需求：2.2, 2.3, 2.4, 2.5, 2.6, 2.7**
  
  - [ ] 4.3 实现项目级权限
    - 创建 project_members 表
    - 实现项目权限覆盖逻辑
    - _需求：2.6, 2.8_

- [ ] 5. 实现数据隔离机制（关键安全功能）
  - [ ] 5.1 实现租户上下文中间件
    - 从请求中提取 organizationId
    - 创建 TenantContext
    - _需求：26.2_
  
  - [ ] 5.2 实现 TenantAwareRepository
    - 自动注入 organizationId 过滤
    - 实现双重验证机制
    - _需求：26.2, 26.3_
  
  - [ ]* 5.3 为数据隔离编写属性测试（最关键）
    - **属性 38：数据隔离完整性** - 验证跨租户访问被阻止
    - **验证需求：26.2, 26.3, 26.6**
  
  - [ ] 5.4 实现数据加密
    - 敏感字段加密（密码、API密钥）
    - 配置 TLS
    - _需求：25.1, 25.2, 25.3, 25.4_

- [ ] 6. 实现订阅和配额管理
  - [ ] 6.1 创建 Subscription 对象类型
    - 定义订阅套餐枚举
    - 创建 subscriptions 表
    - 创建 quota_definitions 表
    - _需求：28.1, 28.3, 28.4, 28.5_
  
  - [ ] 6.2 实现 SubscriptionService
    - getSubscription 方法
    - checkQuota 方法
    - upgradeSubscription/downgradeSubscription
    - _需求：28.7, 28.8_
  
  - [ ]* 6.3 为配额管理编写属性测试
    - **属性 39：配额限制强制执行** - 验证配额检查
    - **属性 40：订阅降级配额调整** - 验证降级时的配额验证
    - **验证需求：28.8, 28.7**

- [ ] 7. 检查点 - 基础架构验证
  - 确保所有测试通过
  - 验证多租户数据隔离
  - 验证权限系统工作正常
  - 验证配额限制生效
  - 询问用户是否有问题

### 第二阶段：项目协作和本体对象

- [ ] 8. 实现 Project 对象类型
  - [ ] 8.1 扩展现有 projects 表
    - 添加 organization_id 字段
    - 添加 approval_enabled 字段
    - 添加审批配置字段
    - 创建迁移脚本（兼容现有数据）
    - _需求：4.1, 5.1_
  
  - [ ] 8.2 实现项目共享功能
    - 创建 ShareProjectAction
    - 实现访问级别控制
    - _需求：4.1, 4.2_
  
  - [ ]* 8.3 为项目共享编写属性测试
    - **属性 11：项目共享建立访问关系** - 验证共享权限
    - **验证需求：4.1, 4.2**

- [ ] 9. 实现 Comment 对象类型
  - [ ] 9.1 创建 Comment 对象和数据库表
    - 定义 Comment 接口
    - 创建 comments 表（支持线程）
    - 实现评论查询方法
    - _需求：4.5, 4.6_
  
  - [ ] 9.2 实现 CreateCommentAction
    - 创建评论
    - 处理 @ 提及
    - 发送通知
    - _需求：4.8, 4.9_
  
  - [ ]* 9.3 为评论系统编写属性测试
    - **属性 12：评论包含完整元数据** - 验证评论数据完整性
    - **属性 13：评论回复线程结构** - 验证回复关系
    - **属性 14：提及触发通知** - 验证通知发送
    - **验证需求：4.6, 4.7, 4.9**
  
  - [ ] 9.4 实现评论编辑和删除
    - EditCommentAction
    - DeleteCommentAction（软删除）
    - _需求：4.10_

- [ ] 10. 实现 ChangeRequest 对象类型和审批流程
  - [ ] 10.1 创建 ChangeRequest 对象
    - 定义 ChangeRequest 接口
    - 创建 change_requests 表
    - 定义变更状态枚举
    - _需求：5.2, 5.3, 5.4_
  
  - [ ] 10.2 实现 CreateChangeRequestAction
    - 创建变更请求
    - 验证审批是否启用
    - 通知审批者
    - _需求：5.2, 5.3, 5.5_
  
  - [ ] 10.3 实现审批 Actions
    - ApproveChangeRequestAction
    - RejectChangeRequestAction
    - 应用变更逻辑
    - 创建 DecisionReceipt
    - _需求：5.6, 5.7, 5.8_
  
  - [ ]* 10.4 为审批流程编写属性测试
    - **属性 15：审批流程强制变更请求** - 验证审批强制
    - **属性 16：批准变更应用修改** - 验证批准后的变更应用
    - **属性 17：拒绝变更保持原状** - 验证拒绝后状态不变
    - **属性 18：审批历史完整记录** - 验证历史记录
    - **验证需求：5.2, 5.4, 5.6, 5.7, 5.9**

- [ ] 11. 实现通知系统
  - [ ] 11.1 创建 Notification 对象类型
    - 定义 Notification 接口
    - 创建 notifications 表
    - 创建 notification_preferences 表
    - _需求：6.1, 6.6_
  
  - [ ] 11.2 实现 NotificationService
    - sendNotification 方法
    - sendEmail 方法（集成 SMTP）
    - getNotifications 方法
    - markAsRead 方法
    - _需求：6.2, 6.3, 6.4, 6.5, 6.9_
  
  - [ ]* 11.3 为通知系统编写单元测试
    - 测试各种事件触发通知
    - 测试通知偏好过滤
    - _需求：6.1-6.10_

- [ ] 12. 实现成员邀请功能
  - [ ] 12.1 创建 Invitation 对象类型
    - 定义 Invitation 接口
    - 创建 invitations 表
    - _需求：3.1, 3.2_
  
  - [ ] 12.2 实现邀请 Actions
    - InviteMemberAction（生成令牌，发送邮件）
    - AcceptInvitationAction
    - RevokeInvitationAction
    - _需求：3.1, 3.3, 3.4, 3.6_
  
  - [ ]* 12.3 为邀请系统编写属性测试
    - **属性 8：邀请令牌唯一性和过期** - 验证令牌管理
    - **属性 9：接受邀请创建成员关系** - 验证邀请接受
    - **属性 10：移除成员撤销访问** - 验证成员移除
    - **验证需求：3.2, 3.3, 3.4, 3.5, 3.8**

- [ ] 13. 检查点 - 协作功能验证
  - 确保所有测试通过
  - 验证项目共享和协作
  - 验证评论和通知
  - 验证审批流程
  - 询问用户是否有问题


### 第三阶段：版本控制和审计

- [ ] 14. 实现 Version 对象类型
  - [ ] 14.1 创建 Version 对象和数据库表
    - 定义 Version 接口
    - 创建 versions 表
    - 实现版本号生成逻辑
    - _需求：7.1, 7.2, 7.3_
  
  - [ ] 14.2 实现 CreateVersionAction
    - 获取项目完整快照
    - 创建版本对象
    - 支持自定义标签
    - _需求：7.1, 7.2, 7.4_
  
  - [ ]* 14.3 为版本创建编写属性测试
    - **属性 19：版本创建保存完整快照** - 验证快照完整性
    - **验证需求：7.1, 7.2**
  
  - [ ] 14.4 实现版本比较功能
    - compareVersions 方法
    - 差异检测算法
    - 差异高亮显示
    - _需求：7.7, 7.8_
  
  - [ ]* 14.5 为版本比较编写属性测试
    - **属性 20：版本比较识别差异** - 验证差异检测
    - **验证需求：7.7, 7.8**
  
  - [ ] 14.6 实现版本回滚功能
    - RevertToVersionAction
    - 恢复项目状态
    - 创建回滚版本记录
    - _需求：7.9, 7.10_
  
  - [ ]* 14.7 为版本回滚编写属性测试（关键往返属性）
    - **属性 21：版本回滚往返一致性** - 验证往返操作
    - **验证需求：7.9, 7.10**

- [ ] 15. 实现变更日志系统
  - [ ] 15.1 创建 ChangeLog 对象类型
    - 定义 ChangeLog 接口
    - 创建 change_logs 表
    - _需求：8.1, 8.2_
  
  - [ ] 15.2 实现变更日志记录中间件
    - 拦截所有修改操作
    - 记录变更前后值
    - 记录操作者和时间戳
    - _需求：8.2, 8.3_
  
  - [ ]* 15.3 为变更日志编写属性测试
    - **属性 22：变更日志记录所有修改** - 验证日志完整性
    - **验证需求：8.1, 8.2**
  
  - [ ] 15.4 实现变更日志查询和导出
    - 按时间、操作者、类型筛选
    - 导出为 CSV/JSON
    - _需求：8.5, 8.6, 8.7, 8.9_

- [ ] 16. 实现 DecisionReceipt 对象类型（关键）
  - [ ] 16.1 创建 DecisionReceipt 对象和数据库表
    - 定义 DecisionReceipt 接口
    - 创建 decision_receipts 表
    - _需求：5.9, 10.11_
  
  - [ ] 16.2 集成 DecisionReceipt 到所有关键 Actions
    - 在 ApproveChangeRequestAction 中创建收据
    - 在其他关键操作中创建收据
    - 记录输入、策略、审批、结果
    - _需求：5.9_
  
  - [ ]* 16.3 为 DecisionReceipt 编写单元测试
    - 测试收据创建
    - 测试收据查询
    - _需求：5.9_

- [ ] 17. 实现审计日志系统
  - [ ] 17.1 创建 AuditLog 对象类型
    - 定义 AuditLog 接口
    - 创建 audit_logs 表
    - _需求：10.1, 10.6_
  
  - [ ] 17.2 实现 AuditService
    - logAction 方法
    - logSecurityEvent 方法
    - getAuditLogs 方法（带筛选）
    - exportAuditLogs 方法
    - _需求：10.2, 10.3, 10.4, 10.5, 10.9, 10.10_
  
  - [ ]* 17.3 为审计日志编写属性测试
    - **属性 24：审计日志不可修改** - 验证日志不可变性
    - **属性 25：安全事件被审计** - 验证安全操作记录
    - **验证需求：10.11, 10.2-10.5**
  
  - [ ] 17.4 集成审计日志到所有 Actions
    - 在 Action 基类中自动记录
    - 记录 IP 地址和用户代理
    - _需求：10.7, 10.9_

- [ ] 18. 实现备份和恢复功能
  - [ ] 18.1 创建 Backup 对象类型
    - 定义 Backup 接口
    - 创建 backups 表
    - _需求：9.1, 9.5_
  
  - [ ] 18.2 实现 BackupService
    - createBackup 方法（完整数据导出）
    - restoreFromBackup 方法
    - scheduleAutoBackup 方法
    - _需求：9.1, 9.4, 9.8_
  
  - [ ]* 18.3 为备份恢复编写属性测试（关键往返属性）
    - **属性 23：备份包含完整数据** - 验证备份往返一致性
    - **验证需求：9.4, 9.8**
  
  - [ ] 18.4 实现自动备份调度
    - 每日自动备份
    - 保留策略（30天）
    - _需求：9.1, 9.2_

- [ ] 19. 检查点 - 数据管理验证
  - 确保所有测试通过
  - 验证版本控制和回滚
  - 验证审计日志记录
  - 验证备份和恢复
  - 询问用户是否有问题

### 第四阶段：高级分析功能

- [ ] 20. 实现复杂度分析引擎
  - [ ] 20.1 实现复杂度计算算法
    - 计算项目复杂度评分
    - 计算模块复杂度评分
    - 考虑模块数、实体数、关系数、依赖深度
    - _需求：11.1, 11.2, 11.3_
  
  - [ ]* 20.2 为复杂度分析编写属性测试
    - **属性 26：复杂度评分单调性** - 验证复杂度增长
    - **属性 27：循环依赖识别** - 验证循环依赖检测
    - **验证需求：11.1, 11.2, 11.8**
  
  - [ ] 20.3 实现复杂度可视化
    - 颜色编码（绿、黄、红）
    - 复杂度趋势图
    - _需求：11.4, 11.6_
  
  - [ ] 20.4 实现复杂度建议
    - 识别高复杂度模块
    - 提供降低建议
    - _需求：11.5, 11.7_

- [ ] 21. 实现技术债务识别
  - [ ] 21.1 实现技术债务检测规则
    - 过多依赖检测（>10个）
    - 过多属性检测（>20个）
    - 循环依赖检测
    - 缺少文档检测
    - _需求：12.2, 12.3, 12.4, 12.5_
  
  - [ ]* 21.2 为技术债务编写属性测试
    - **属性 28：技术债务检测一致性** - 验证检测规则
    - **验证需求：12.2-12.5**
  
  - [ ] 21.3 实现技术债务管理
    - 严重程度分配
    - 状态管理（已解决、已接受）
    - 趋势跟踪
    - _需求：12.6, 12.8, 12.9_

- [ ] 22. 实现依赖关系分析
  - [ ] 22.1 实现依赖图生成
    - 生成完整依赖图
    - 计算入度和出度
    - 识别循环依赖路径
    - _需求：13.1, 13.2, 13.4, 13.5_
  
  - [ ]* 22.2 为依赖图编写属性测试
    - **属性 29：依赖图完整性** - 验证图的完整性
    - **验证需求：13.1, 13.2**
  
  - [ ] 22.3 实现依赖图可视化
    - 交互式图形（缩放、拖拽）
    - 分层显示
    - 筛选功能
    - _需求：13.3, 13.6, 13.7_
  
  - [ ] 22.4 实现耦合度计算
    - 计算模块间耦合度
    - _需求：13.8_

- [ ] 23. 实现影响范围评估
  - [ ] 23.1 实现影响分析算法
    - 识别直接依赖
    - 识别传递依赖
    - 计算影响广度和深度
    - _需求：14.2, 14.3, 14.6_
  
  - [ ]* 23.2 为影响分析编写属性测试
    - **属性 30：影响分析传递性** - 验证传递依赖
    - **验证需求：14.3**
  
  - [ ] 23.3 实现影响可视化
    - 高亮受影响模块
    - 显示影响路径
    - 风险评估
    - _需求：14.4, 14.5, 14.7_

- [ ] 24. 检查点 - 分析功能验证
  - 确保所有测试通过
  - 验证复杂度分析准确性
  - 验证技术债务识别
  - 验证依赖和影响分析
  - 询问用户是否有问题


### 第五阶段：知识管理

- [ ] 25. 实现架构文档生成
  - [ ] 25.1 实现文档生成引擎
    - 创建 Markdown 模板
    - 实现模板渲染
    - 嵌入架构图
    - _需求：15.1, 15.2, 15.3_
  
  - [ ] 25.2 实现文档导出
    - 导出为 Markdown
    - 导出为 PDF（使用 Puppeteer）
    - 批量生成
    - _需求：15.6, 15.8_
  
  - [ ]* 25.3 为文档生成编写单元测试
    - 测试模板渲染
    - 测试各种格式导出
    - _需求：15.1-15.8_
  
  - [ ] 25.4 实现自定义模板
    - 模板管理
    - 章节选择
    - _需求：15.4, 15.5_

- [ ] 26. 实现 ADR 管理
  - [ ] 26.1 创建 ADR 对象类型
    - 定义 ADR 接口
    - 创建 adrs 表
    - 定义 ADR 状态枚举
    - _需求：16.1, 16.2, 16.3_
  
  - [ ] 26.2 实现 ADR Actions
    - CreateADRAction
    - UpdateADRAction
    - SupersedeADRAction（替代关系）
    - _需求：16.1, 16.2, 16.6_
  
  - [ ]* 26.3 为 ADR 管理编写单元测试
    - 测试 ADR 创建和更新
    - 测试替代关系
    - 测试模块关联
    - _需求：16.1-16.10_
  
  - [ ] 26.4 实现 ADR 查询和搜索
    - 按状态筛选
    - 全文搜索
    - 关联模块查询
    - _需求：16.7, 16.8, 16.9_
  
  - [ ] 26.5 集成 ADR 到文档生成
    - 在架构文档中包含 ADR 章节
    - _需求：16.10_

- [ ] 27. 实现全局搜索功能
  - [ ] 27.1 实现搜索引擎（使用 Elasticsearch 或 PostgreSQL 全文搜索）
    - 索引项目、模块、实体、ADR
    - 实现全文搜索
    - 相关性排序
    - _需求：17.1, 17.2, 17.3_
  
  - [ ] 27.2 实现搜索权限过滤
    - 只返回有权限的结果
    - _需求：17.8_
  
  - [ ]* 27.3 为搜索编写属性测试
    - **属性 31：搜索结果权限过滤** - 验证权限过滤
    - **验证需求：17.8**
  
  - [ ] 27.4 实现搜索功能增强
    - 关键词高亮
    - 上下文片段
    - 按类型筛选
    - 按项目筛选
    - 搜索历史
    - _需求：17.4, 17.5, 17.6, 17.7, 17.9_

- [ ] 28. 实现标签系统
  - [ ] 28.1 创建 Tag 对象类型
    - 定义 Tag 接口
    - 创建 tags 表
    - 创建 resource_tags 关联表
    - _需求：18.1, 18.2_
  
  - [ ] 28.2 实现标签 Actions
    - CreateTagAction
    - AddTagToResourceAction
    - RemoveTagFromResourceAction
    - DeleteTagAction
    - _需求：18.3, 18.8, 18.9_
  
  - [ ]* 28.3 为标签系统编写属性测试
    - **属性 32：标签删除级联清理** - 验证标签删除
    - **验证需求：18.9**
  
  - [ ] 28.4 实现标签功能
    - 颜色标记
    - 按标签筛选
    - 使用次数统计
    - _需求：18.4, 18.6, 18.7_

- [ ] 29. 检查点 - 知识管理验证
  - 确保所有测试通过
  - 验证文档生成
  - 验证 ADR 管理
  - 验证搜索功能
  - 验证标签系统
  - 询问用户是否有问题

### 第六阶段：集成和 API

- [ ] 30. 实现 RESTful API
  - [ ] 30.1 设计 API 路由和端点
    - 定义 API 版本策略（/api/v1）
    - 设计资源端点
    - 定义请求/响应格式
    - _需求：19.1_
  
  - [ ] 30.2 实现 API 认证
    - 创建 ApiKey 对象类型
    - 创建 api_keys 表
    - 实现 API 密钥生成和验证
    - _需求：19.2, 19.3, 19.4, 19.5_
  
  - [ ] 30.3 实现 API 速率限制
    - 使用 Redis 实现速率限制
    - 根据订阅套餐设置限制
    - 返回 429 状态码
    - _需求：19.6, 19.7_
  
  - [ ]* 30.4 为 API 速率限制编写属性测试
    - **属性 33：API 速率限制强制执行** - 验证速率限制
    - **验证需求：19.6, 19.7**
  
  - [ ] 30.5 实现 API 文档
    - 使用 Swagger/OpenAPI 生成文档
    - 实现分页
    - _需求：19.8, 19.9_
  
  - [ ] 30.6 集成 API 审计日志
    - 记录所有 API 请求
    - _需求：19.10_

- [ ] 31. 实现 Webhook 系统
  - [ ] 31.1 创建 Webhook 对象类型
    - 定义 Webhook 接口
    - 创建 webhooks 表
    - 创建 webhook_logs 表
    - _需求：20.1, 20.2_
  
  - [ ] 31.2 实现 Webhook 配置
    - CreateWebhookAction
    - 事件订阅选择
    - URL 验证
    - 签名生成
    - _需求：20.2, 20.3, 20.7_
  
  - [ ] 31.3 实现 Webhook 触发机制
    - 事件监听器
    - HTTP POST 请求发送
    - 重试机制（指数退避）
    - _需求：20.5, 20.6, 20.8_
  
  - [ ]* 31.4 为 Webhook 编写属性测试
    - **属性 34：Webhook 重试机制** - 验证重试逻辑
    - **验证需求：20.8, 20.9**
  
  - [ ] 31.5 实现 Webhook 管理
    - 发送历史记录
    - 测试功能
    - _需求：20.9, 20.10_

- [ ] 32. 实现第三方集成
  - [ ] 32.1 创建 Integration 对象类型
    - 定义 Integration 接口
    - 创建 integrations 表
    - 加密存储配置
    - _需求：21.9_
  
  - [ ] 32.2 实现 JIRA 集成
    - 配置 JIRA 连接
    - 项目关联
    - 数据同步
    - _需求：21.1, 21.2, 21.3_
  
  - [ ] 32.3 实现 Confluence 集成
    - 配置 Confluence 连接
    - 发布架构文档
    - _需求：21.4, 21.5_
  
  - [ ] 32.4 实现 GitLab 集成
    - 配置 GitLab 连接
    - 模块关联到仓库
    - _需求：21.6, 21.7, 21.8_
  
  - [ ]* 32.5 为第三方集成编写单元测试
    - 测试各集成的配置和连接
    - 测试数据同步
    - _需求：21.1-21.10_

- [ ] 33. 实现数据导入导出增强
  - [ ] 33.1 实现多格式导出
    - JSON 格式导出
    - Excel 格式导出
    - PlantUML 格式导出
    - _需求：22.1, 22.2, 22.3_
  
  - [ ] 33.2 实现数据导入
    - JSON 格式导入
    - 数据验证
    - 冲突处理（合并/覆盖）
    - _需求：22.4, 22.5, 22.6_
  
  - [ ]* 33.3 为导入导出编写属性测试（关键往返属性）
    - **属性 35：数据导入导出往返一致性** - 验证往返操作
    - **验证需求：22.1, 22.4, 22.5**
  
  - [ ] 33.4 实现导入导出增强功能
    - 批量导出
    - 版本信息包含
    - 字段映射
    - _需求：22.7, 22.8, 22.9_

- [ ] 34. 检查点 - 集成功能验证
  - 确保所有测试通过
  - 验证 API 功能和速率限制
  - 验证 Webhook 触发和重试
  - 验证第三方集成
  - 验证数据导入导出
  - 询问用户是否有问题


### 第七阶段：企业服务和安全

- [ ] 35. 实现 SSO 单点登录
  - [ ] 35.1 创建 SSOConfig 对象类型
    - 定义 SSOConfig 接口
    - 创建 sso_configs 表
    - _需求：23.1, 23.2_
  
  - [ ] 35.2 实现 SAML 2.0 支持
    - 配置 SAML IdP
    - 验证 SAML 断言
    - JIT 用户配置
    - _需求：23.1, 23.2, 23.4, 23.6_
  
  - [ ]* 35.3 为 SSO 编写属性测试
    - **属性 36：SSO 令牌验证** - 验证令牌验证逻辑
    - **验证需求：23.4**
  
  - [ ] 35.3 实现 OAuth 2.0 / OpenID Connect 支持
    - 配置 OAuth 提供商
    - 验证 OAuth 令牌
    - _需求：23.3, 23.4_
  
  - [ ] 35.4 实现 SSO 功能
    - 用户属性同步
    - 可选/强制 SSO
    - Single Logout
    - _需求：23.7, 23.8, 23.9, 23.10_

- [ ] 36. 实现 LDAP/AD 集成
  - [ ] 36.1 创建 LDAPConfig 对象类型
    - 定义 LDAPConfig 接口
    - 创建 ldap_configs 表
    - _需求：24.1, 24.2_
  
  - [ ] 36.2 实现 LDAP 认证
    - 连接 LDAP 服务器
    - 用户认证
    - _需求：24.3_
  
  - [ ] 36.3 实现 LDAP 用户同步
    - 同步用户列表
    - 组映射到部门
    - 定期自动同步
    - _需求：24.4, 24.5, 24.6, 24.7_
  
  - [ ]* 36.4 为 LDAP 同步编写属性测试
    - **属性 37：LDAP 同步幂等性** - 验证同步幂等性
    - **验证需求：24.4, 24.5**
  
  - [ ] 36.5 实现同步管理
    - 手动触发同步
    - 同步日志
    - _需求：24.8, 24.9, 24.10_

- [ ] 37. 实现双因素认证（2FA）
  - [ ] 37.1 实现 TOTP 支持
    - 生成 2FA 密钥
    - 验证 TOTP 代码
    - _需求：25.6, 25.7_
  
  - [ ]* 37.2 为 2FA 编写单元测试
    - 测试密钥生成
    - 测试代码验证
    - _需求：25.6, 25.7_
  
  - [ ] 37.3 实现 2FA 管理
    - 启用/禁用 2FA
    - 恢复代码
    - _需求：25.6, 25.7_

- [ ] 38. 实现安全增强功能
  - [ ] 38.1 实现密码策略
    - 密码复杂度要求
    - 密码哈希（bcrypt/Argon2）
    - _需求：25.4, 25.5_
  
  - [ ] 38.2 实现会话管理
    - 会话超时（30分钟）
    - 可疑登录检测
    - 安全警报
    - _需求：25.8, 25.9_
  
  - [ ] 38.3 实现 IP 白名单（企业版功能）
    - IP 白名单配置
    - IP 验证中间件
    - _需求：25.10_

- [ ] 39. 实现合规性支持
  - [ ] 39.1 实现 GDPR 数据导出
    - 用户数据导出功能
    - _需求：27.1_
  
  - [ ] 39.2 实现 GDPR 数据删除
    - 账户删除功能
    - 数据清除（30天内）
    - _需求：27.2, 27.3_
  
  - [ ] 39.3 实现合规性报告
    - 访问日志报告
    - 变更日志报告
    - 审计日志报告
    - _需求：27.7_
  
  - [ ]* 39.4 为合规性功能编写单元测试
    - 测试数据导出
    - 测试数据删除
    - _需求：27.1-27.8_
  
  - [ ] 39.5 实现隐私政策和服务条款
    - 接受记录
    - DPA 签署
    - _需求：27.4, 27.6_

- [ ] 40. 实现私有化部署支持
  - [ ] 40.1 创建 Docker 容器化方案
    - Dockerfile
    - docker-compose.yml
    - _需求：31.1_
  
  - [ ] 40.2 创建 Kubernetes 部署方案
    - Helm Chart
    - 配置模板
    - _需求：31.2_
  
  - [ ] 40.3 编写部署文档
    - 部署指南
    - 配置说明
    - 环境变量文档
    - _需求：31.3, 31.8_
  
  - [ ] 40.4 实现外部服务支持
    - 外部数据库配置
    - 外部对象存储配置
    - 外部缓存配置
    - _需求：31.4, 31.5, 31.6_
  
  - [ ] 40.5 实现健康检查和监控
    - /health 端点
    - /metrics 端点（Prometheus 格式）
    - _需求：31.7, 32.1, 32.2_

- [ ] 41. 检查点 - 企业服务验证
  - 确保所有测试通过
  - 验证 SSO 和 LDAP 集成
  - 验证 2FA 和安全功能
  - 验证合规性功能
  - 验证部署方案
  - 询问用户是否有问题

### 第八阶段：计费、监控和优化

- [ ] 42. 实现计费系统
  - [ ] 42.1 集成 Stripe 支付网关
    - 配置 Stripe SDK
    - 创建客户
    - 创建订阅
    - _需求：29.1, 29.2_
  
  - [ ] 42.2 实现订阅管理
    - 月度/年度订阅
    - 订阅升级/降级
    - 订阅取消
    - _需求：29.3, 29.4, 29.11_
  
  - [ ] 42.3 实现支付处理
    - 支付失败重试
    - 续费提醒
    - _需求：29.5, 29.6_
  
  - [ ]* 42.4 为计费系统编写单元测试
    - 测试订阅创建和管理
    - 测试支付处理
    - _需求：29.1-29.11_
  
  - [ ] 42.5 实现发票管理
    - 生成发票
    - 发送发票邮件
    - 下载发票 PDF
    - _需求：29.7, 29.8, 29.10_

- [ ] 43. 实现使用统计
  - [ ] 43.1 创建 UsageRecord 对象类型
    - 定义 UsageRecord 接口
    - 创建 usage_records 表
    - _需求：30.1, 30.2, 30.3, 30.4_
  
  - [ ] 43.2 实现使用量收集
    - 活跃用户统计
    - 项目操作统计
    - API 调用统计
    - 存储使用统计
    - _需求：30.1, 30.2, 30.3, 30.4_
  
  - [ ] 43.3 实现统计可视化
    - 趋势图表
    - 最活跃用户/项目
    - 功能使用率
    - _需求：30.5, 30.6, 30.7_
  
  - [ ]* 43.4 为使用统计编写单元测试
    - 测试统计收集
    - 测试统计查询
    - _需求：30.1-30.9_
  
  - [ ] 43.5 实现统计导出
    - 导出报告
    - 时间范围筛选
    - _需求：30.8, 30.9_

- [ ] 44. 实现系统监控
  - [ ] 44.1 实现监控指标收集
    - 数据库连接池状态
    - API 响应时间和错误率
    - 内存和 CPU 使用率
    - 磁盘空间使用
    - _需求：32.3, 32.4, 32.5, 32.6_
  
  - [ ] 44.2 实现告警系统
    - 阈值配置
    - 告警通知（邮件、Slack、PagerDuty）
    - _需求：32.7, 32.8_
  
  - [ ]* 44.3 为监控系统编写单元测试
    - 测试指标收集
    - 测试告警触发
    - _需求：32.1-32.10_
  
  - [ ] 44.4 实现日志管理
    - 日志级别配置
    - 错误日志记录
    - _需求：32.9, 32.10_

- [ ] 45. 实现性能优化
  - [ ] 45.1 实现数据库优化
    - 添加必要索引
    - 查询优化
    - 连接池管理
    - _需求：33.3, 33.9_
  
  - [ ] 45.2 实现缓存策略
    - Redis 缓存配置
    - 缓存复杂度分析结果
    - 缓存依赖图
    - _需求：33.4, 33.10_
  
  - [ ] 45.3 实现前端优化
    - 分页实现
    - 懒加载
    - 响应压缩
    - CDN 配置
    - _需求：33.5, 33.6, 33.7, 33.8_
  
  - [ ]* 45.4 进行性能测试
    - 页面加载时间测试
    - 架构图渲染性能测试
    - 并发用户测试
    - _需求：33.1, 33.2_

- [ ] 46. 实现国际化
  - [ ] 46.1 设置 i18n 框架
    - 配置 i18next 或类似库
    - 创建翻译文件（中文、英文）
    - _需求：34.1, 34.4_
  
  - [ ] 46.2 实现语言切换
    - 自动语言检测
    - 手动语言切换
    - 语言偏好保存
    - _需求：34.2, 34.3, 34.9_
  
  - [ ] 46.3 实现本地化
    - 日期时间格式
    - 数字和货币格式
    - _需求：34.6, 34.7_
  
  - [ ]* 46.4 为国际化编写单元测试
    - 测试翻译加载
    - 测试语言切换
    - _需求：34.1-34.9_
  
  - [ ] 46.5 翻译所有文本
    - UI 文本翻译
    - 通知和邮件翻译
    - API 错误消息翻译
    - _需求：34.4, 34.5, 34.8_

- [ ] 47. 实现移动端适配
  - [ ] 47.1 实现响应式设计
    - 使用 CSS 媒体查询
    - 适配不同屏幕尺寸
    - _需求：35.1, 35.5_
  
  - [ ] 47.2 优化移动端交互
    - 简化导航菜单
    - 触摸交互优化
    - 手势支持
    - _需求：35.2, 35.3, 35.4_
  
  - [ ] 47.3 优化移动端性能
    - 减少加载时间
    - 优化表单输入
    - _需求：35.6, 35.8_
  
  - [ ]* 47.4 进行移动端测试
    - 在不同设备上测试
    - 验证所有功能可用
    - _需求：35.7_

- [ ] 48. 最终检查点 - 完整系统验证
  - 运行所有测试套件（单元测试 + 属性测试）
  - 进行端到端集成测试
  - 进行性能和负载测试
  - 进行安全测试（数据隔离、权限绕过尝试）
  - 验证所有8个阶段的功能
  - 生成测试覆盖率报告
  - 准备发布文档
  - 询问用户是否准备好发布

## 注意事项

1. **测试优先**：每个功能实现后立即编写测试，特别是属性测试
2. **增量交付**：每个阶段结束时都应该有可演示的功能
3. **数据迁移**：第一阶段需要创建迁移脚本，兼容现有用户数据
4. **性能监控**：在开发过程中持续监控性能指标
5. **安全审查**：特别关注数据隔离和权限检查的实现
6. **文档更新**：随着实施更新 API 文档和用户文档
7. **代码审查**：关键功能（Actions、权限、数据隔离）需要严格审查

## 测试配置

所有属性测试使用 `fast-check` 库，配置如下：

```typescript
import fc from 'fast-check';

// 每个属性测试至少运行 100 次迭代
fc.assert(
  fc.asyncProperty(/* ... */),
  { numRuns: 100 }
);
```

每个属性测试必须包含注释标记：
```typescript
// Feature: enterprise-saas-upgrade, Property X: [属性名称]
```

