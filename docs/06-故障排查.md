# 🔧 故障排查指南

## 🐛 常见问题

### 1. 登录显示 "Failed to fetch"

**原因**: 前端无法连接到后端 API

**解决方法**:

```bash
# 1. 检查后端是否运行
docker-compose ps

# 2. 检查后端日志
docker-compose logs backend --tail=50

# 3. 测试 API 连接
curl http://localhost:5000/health

# 4. 重启后端
docker-compose restart backend

# 5. 清除浏览器缓存并硬刷新（Ctrl+F5）
```

### 2. Docker 无法启动

**原因**: 虚拟化未启用

**解决方法**:

在 Windows 上启用虚拟化：

1. 以管理员身份打开 PowerShell
2. 运行以下命令：
   ```powershell
   Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Hyper-V-All -All
   Enable-WindowsOptionalFeature -Online -FeatureName VirtualMachinePlatform -All
   ```
3. 重启电脑

或者进入 BIOS 启用虚拟化：
1. 重启电脑
2. 按 F2/F10/Del 进入 BIOS
3. 找到 "Intel Virtualization Technology" 或 "VT-x"
4. 设置为 Enabled
5. 保存并退出

### 3. 容器构建失败

**原因**: 网络问题或依赖下载失败

**解决方法**:

```bash
# 1. 清理旧容器和镜像
docker-compose down
docker system prune -a

# 2. 重新构建
docker-compose up -d --build

# 3. 如果还是失败，检查网络
ping docker.io
```

### 4. 数据库连接失败

**原因**: PostgreSQL 未启动或配置错误

**解决方法**:

```bash
# 1. 检查数据库容器
docker-compose ps postgres

# 2. 查看数据库日志
docker-compose logs postgres --tail=50

# 3. 进入数据库测试
docker exec -it blueprint_postgres psql -U postgres

# 4. 检查环境变量（Windows 使用 type .env）
cat .env
```

### 5. 端口被占用

**错误信息**: "port is already allocated"

**解决方法**:

```bash
# 查看端口占用（Windows）
netstat -ano | findstr :3000
netstat -ano | findstr :5000
netstat -ano | findstr :5432

# 停止占用端口的进程
# 或修改 docker-compose.yml 中的端口映射
```

### 6. 前端页面空白

**原因**: 构建失败或路由问题

**解决方法**:

```bash
# 1. 查看前端日志
docker-compose logs frontend --tail=50

# 2. 检查浏览器控制台（F12）

# 3. 重新构建前端
docker-compose up -d --build frontend

# 4. 清除浏览器缓存
```

### 7. 注册失败

**可能原因**:
- 邮箱已被注册
- 密码少于 6 位
- 后端 API 错误

**解决方法**:

```bash
# 1. 查看后端日志
docker-compose logs backend --tail=50

# 2. 检查数据库
docker exec -it blueprint_postgres psql -U postgres blueprint_saas
SELECT * FROM users;
\q

# 3. 尝试不同的邮箱
```

## 🔍 诊断命令

### 检查服务状态

```bash
# 查看所有容器
docker-compose ps

# 查看容器详情
docker inspect blueprint_backend
docker inspect blueprint_frontend
docker inspect blueprint_postgres

# 查看资源使用
docker stats
```

### 查看日志

```bash
# 实时查看所有日志
docker-compose logs -f

# 查看特定服务日志
docker-compose logs backend -f
docker-compose logs frontend -f
docker-compose logs postgres -f

# 查看最近 100 行
docker-compose logs --tail=100
```

### 测试连接

```bash
# 测试后端 API
curl http://localhost:5000/health

# 测试前端
curl http://localhost:3000

# 测试数据库
docker exec blueprint_postgres pg_isready -U postgres
```

## 🛠️ 重置和清理

### 完全重置

```bash
# 1. 停止所有容器
docker-compose down

# 2. 删除所有数据（警告：会丢失数据！）
docker-compose down -v

# 3. 清理 Docker 系统
docker system prune -a

# 4. 重新启动
docker-compose up -d --build
```

### 只重置数据库

```bash
# 1. 停止服务
docker-compose down

# 2. 删除数据库卷
docker volume rm blue_postgres_data

# 3. 重新启动
docker-compose up -d
```

## 📊 性能问题

### 容器运行缓慢

**解决方法**:

1. 增加 Docker Desktop 资源分配：
   - 打开 Docker Desktop
   - Settings → Resources
   - 增加 CPU 和内存

2. 检查磁盘空间：
   ```bash
   docker system df
   ```

3. 清理未使用的资源：
   ```bash
   docker system prune
   ```

## 🆘 获取帮助

如果以上方法都无法解决问题：

1. **收集信息**:
   ```bash
   # 导出所有日志
   docker-compose logs > logs.txt
   
   # 导出容器状态
   docker-compose ps > status.txt
   
   # 导出系统信息
   docker info > docker-info.txt
   ```

2. **检查配置**:
   - 查看 `.env` 文件
   - 查看 `docker-compose.yml`
   - 查看浏览器控制台（F12）

3. **提供详细信息**:
   - 操作系统版本
   - Docker 版本
   - 错误信息截图
   - 相关日志

---

**大多数问题都可以通过重启服务解决：`docker-compose restart`**
